varnishtest "Test netmapper vmod"

server s1 {
       rxreq
       expect req.http.X-CS == "localhosty"
       expect req.http.X-CS-T1 == "localhosty"
       expect req.http.X-CS-T2 == "localhosty"
       expect req.http.X-CS-T3 == "Carrier Foo"
       expect req.http.X-CS-T4 == "Carrier Bar"
       expect req.http.X-CS-T5 == "Carrier Foo"
       expect req.http.X-CS-T6 == "Carrier Foo"
       expect req.http.X-CS-T7 == "Carrier Bar"
       expect req.http.X-CS-T8 == <undef>
       expect req.http.X-CS-T9 == "Carrier Bar"
       txresp
} -start

varnish v1 -vcl+backend {
    import netmapper from "${vmod_topbuild}/src/.libs/libvmod_netmapper.so";

    sub vcl_init {
        netmapper.init("${vmod_topsrc}/src/tests/test01.json", 1);
    }

    sub vcl_recv {
        set req.http.X-CS = netmapper.map("" + client.ip);
        set req.http.X-CS-T1 = netmapper.map("127.1.2.3");
        set req.http.X-CS-T2 = netmapper.map("::1");
        set req.http.X-CS-T3 = netmapper.map("192.0.2.75");
        set req.http.X-CS-T4 = netmapper.map("192.0.2.175");
        set req.http.X-CS-T5 = netmapper.map("2001:db8:1234::abcd");
        set req.http.X-CS-T6 = netmapper.map("10.200.100.10");
        set req.http.X-CS-T7 = netmapper.map("172.16.123.123");
        set req.http.X-CS-T8 = netmapper.map("2001:db8:4230::abcd");
        set req.http.X-CS-T9 = netmapper.map("2001:db8:4231::abcd");
        return (pass);
    }
} -start

client c1 {
    txreq -url "/"
    rxresp
}

client c1 -run
